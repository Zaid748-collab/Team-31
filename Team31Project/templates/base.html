{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>{% block title %}My Site{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  {% block extra_css %}{% endblock %}
</head>

<body>
  <header>
    <nav class="navbar">
      <ul class="nav-list">
        <li><a href="{% url 'home' %}" class="nav-link">Home</a></li>
        <li><a href="{% url 'about' %}" class="nav-link">About Us</a></li>
        <li><a href="{% url 'contact' %}" class="nav-link">Contact Us</a></li>
        <li><a href="{% url 'products' %}" class="nav-link">Products</a></li>
        <li><a href="{% url 'signup' %}" class="nav-link">Sign Up</a></li>
      </ul>

      <ul class="nav-icons">
        <li>
          <a href="#" id="basket-icon" class="nav-link">
            <img src="https://res.cloudinary.com/ddh1zbtva/image/upload/v1764076078/cart_adnbat.png" alt="Basket"
              class="nav-icon">
          </a>
        </li>
        <li>
          <a href="#" id="profile-icon" class="nav-link">
            <img src="https://res.cloudinary.com/ddh1zbtva/image/upload/v1764076103/user_g8rtxx.png" alt="Profile"
              class="nav-icon">
          </a>
        </li>

        {% if user.is_authenticated %}
        <li class="nav-link user-info">Logged in as <strong>{{ user.username }}</strong></li>
        <li>
          <form method="post" action="{% url 'logout' %}" class="logout-form">
            {% csrf_token %}
            <button type="submit" class="nav-link logout-link">Logout</button>
          </form>
        </li>
        {% if user.is_superuser %}
        <li><a href="/admin/" class="nav-link">Admin</a></li>
        {% endif %}
        {% else %}
        <li><a href="#" id="login-link" class="nav-link login">Login</a></li>
        {% endif %}
      </ul>
    </nav>
  </header>

  <header>

<div id="popup">

    
    <button id="closePopup">×</button>

    <p>
        <strong>Welcome!</strong> We're glad you're here.
        If you need any help, feel free to reach out through the Contact page.
    </p>

</div>

</header>


  <main class="main-content">
    {% block content %}
    {% endblock %}
  </main>

  <!-- Basket popup -->
  <div id="basket-popup" class="basket-popup">
    <div class="basket-header">
      <h3>Your Basket</h3>
      <button id="close-basket" class="close-btn">&times;</button>
    </div>
    <div id="basket-items" class="basket-items">
    </div>
  </div>

  <!-- Login popup -->
  <div id="login-popup" class="login-popup">
    <div class="login-header">
      <h3>Login</h3>
      <button id="close-login" class="close-btn">&times;</button>
    </div>
    <form id="login-form" class="login-form">
      {% csrf_token %}
      <label for="username">Username</label>
      <input type="text" id="username" name="username" required>

      <label for="password">Password</label>
      <input type="password" id="password" name="password" required>

      <button type="submit" class="login-btn">Login</button>

      <div id="login-error" class="error-msg" style="display:none;"></div>
    </form>
  </div>

  <!-- Temporary notification -->
  <div id="login-notification" class="login-notification">
    You aren’t currently logged in.
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const isAuthenticated = "{{ user.is_authenticated|yesno:'true,false' }}" === "true";
    const profileUrl = "{% url 'profile' %}";
    const basketPopup = document.getElementById("basket-popup");
    const basketItemsDiv = document.getElementById("basket-items");

    // --- Helpers ---
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function renderBasket(data) {
      if (data.items.length > 0) {
        let html = "<ul>";
        data.items.forEach(item => {
          html += `
            <li class="basket-item">
              <img src="${item.image_url}" alt="${item.name}" class="basket-item-img">
              <span class="basket-item-name">${item.name}</span>
              <span class="basket-item-price">£${item.price}</span>
              <span class="basket-item-qty">x${item.quantity}</span>
              <button class="remove-btn" data-product-id="${item.id}">Remove</button>
            </li>`;
        });
        html += `</ul>
          <div class="basket-total">Total: £${data.total}</div>
          <div class="basket-footer">
            <button id="checkout-btn" class="checkout-btn">Checkout</button>
          </div>`;
        basketItemsDiv.innerHTML = html;
      } else {
        basketItemsDiv.innerHTML = `
          <div class="basket-empty">
            <img src="https://res.cloudinary.com/ddh1zbtva/image/upload/v1764096011/empty-cart_vdvkkl.png"
                 alt="Empty Basket" class="basket-empty-img">
            <p>Your basket is empty</p>
          </div>`;
      }
      basketPopup.style.display = "flex";
    }

    // --- Basket popup ---
    document.getElementById("basket-icon").addEventListener("click", async function (e) {
      e.preventDefault();
      const response = await fetch("{% url 'basket' %}");
      const data = await response.json();
      renderBasket(data);
    });

    document.getElementById("close-basket").addEventListener("click", () => {
      basketPopup.style.display = "none";
    });

    // --- Login popup ---
    const loginLink = document.getElementById("login-link");
    const loginPopup = document.getElementById("login-popup");
    const closeLogin = document.getElementById("close-login");

    if (loginLink) {
      loginLink.addEventListener("click", e => {
        e.preventDefault();
        loginPopup.style.display = "flex";
      });
    }
    closeLogin.addEventListener("click", () => loginPopup.style.display = "none");

    // --- Profile icon ---
    document.getElementById("profile-icon").addEventListener("click", e => {
      e.preventDefault();
      if (isAuthenticated) {
        window.location.href = profileUrl;
      } else {
        const loginNotification = document.getElementById("login-notification");
        loginNotification.style.display = "block";
        setTimeout(() => loginNotification.style.display = "none", 3000);
      }
    });

    // --- AJAX login ---
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    loginForm.addEventListener("submit", async e => {
      e.preventDefault();
      const csrfToken = getCookie('csrftoken');
      const formData = new FormData(loginForm);
      const response = await fetch("{% url 'custom_login' %}", {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken },
        body: formData
      });
      const data = await response.json();
      if (data.success) {
        window.location.reload();
      } else {
        loginError.textContent = data.error;
        loginError.style.display = "block";
      }
    });

    // --- Add to basket ---
    document.querySelectorAll(".add-to-basket").forEach(button => {
      button.addEventListener("click", async e => {
        e.preventDefault();
        const productId = button.dataset.productId;
        const csrfToken = getCookie('csrftoken');
        const response = await fetch(`/basket/add/${productId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken, "Content-Type": "application/json" }
        });
        const data = await response.json();
        renderBasket(data);
      });
    });

    // --- Remove + Checkout ---
    document.addEventListener("click", async e => {
      if (e.target.classList.contains("remove-btn")) {
        const productId = e.target.dataset.productId;
        const csrfToken = getCookie('csrftoken');
        const response = await fetch(`/basket/remove/${productId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken }
        });
        const data = await response.json();
        renderBasket(data);
      }
      if (e.target.id === "checkout-btn") {
        window.location.href = "/checkout/";
      }
    });
  });
</script>
</body>

</html>